<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>CIE-297 | Monitoreo en Tiempo Real</title>
<link rel="icon" href="assets/logo.png"/>

<style>
  :root{ --bg:#0b1424;--card:#101b31;--soft:#12213b;--text:#e5ecff;--muted:#93a4c7;
         --ok:#22c55e;--warn:#f59e0b;--danger:#ef4444;--line:rgba(255,255,255,.06); }
  *{box-sizing:border-box} html,body{height:100%}
  body{margin:0;font:14px/1.4 system-ui,Segoe UI,Roboto,Helvetica,Arial;color:var(--text);background:var(--bg)}
  .container{max-width:1200px;margin:0 auto;padding:16px}
  .appbar{display:flex;align-items:center;justify-content:space-between;padding:.75rem 1rem;background:#0b1424;position:sticky;top:0;z-index:40;border-bottom:1px solid var(--line)}
  .brand{display:flex;gap:.6rem;align-items:center;font-weight:800;font-size:18px}
  .brand img{height:32px;width:32px;border-radius:6px}
  .actions{display:flex;gap:.5rem;align-items:center}
  .btn{cursor:pointer;border:1px solid var(--line);background:var(--soft);color:var(--text);padding:.5rem .8rem;border-radius:.6rem}
  .btn:hover{filter:brightness(1.1)} .btn-danger{background:#2b1220;border-color:#ff6b6b;color:#ff9aa9} .btn-secondary{background:#1c2437}
  .badge{display:inline-block;padding:.1rem .6rem;border-radius:999px;border:1px solid var(--line);color:var(--muted)}
  .grid{display:grid;gap:16px} .g-2{grid-template-columns:2fr 1fr}
  .card{background:var(--card);border:1px solid var(--line);border-radius:12px;padding:14px} .card h3{margin:.2rem 0 10px 0}
  .row{display:flex;gap:10px;align-items:center} .col{display:flex;flex-direction:column;gap:6px}
  .control{width:100%;background:#0f1a30;border:1px solid var(--line);color:var(--text);padding:.55rem .6rem;border-radius:8px}
  .table-wrap{overflow:auto;border:1px dashed var(--line);border-radius:10px;margin-top:8px}
  table{width:100%;border-collapse:collapse} th,td{padding:.55rem .6rem;border-bottom:1px solid var(--line);text-align:left;white-space:nowrap}
  thead th{background:#0f1a2e;color:#c7d3ff;font-weight:700} .muted{color:var(--muted)} .right{display:flex;justify-content:flex-end}
  .hidden{display:none !important}
  .chip{display:inline-block;padding:.2rem .6rem;border-radius:999px;font-weight:700;border:1px solid rgba(255,255,255,.15);letter-spacing:.5px}
  .chip--alta{background:#3b0d0d;border-color:var(--danger);color:#ff6b6b}
  .chip--media{background:#3a3000;border-color:var(--warn);color:#ffd166}
  .chip--baja{background:#062b0b;border-color:var(--ok);color:#86efac}
  .modal{position:fixed;inset:0;background:rgba(0,0,0,.55);display:none;align-items:center;justify-content:center;z-index:50}
  .modal .box{width:680px;max-width:92vw;background:var(--card);border:1px solid var(--line);border-radius:14px;padding:16px}
  .title{font-weight:800;margin:0 0 8px 0}
  @media (max-width:980px){ .g-2{grid-template-columns:1fr} }
</style>

<!-- Base API: usamos proxy en Vercel -->
<script> window.CIE297_API = '/api'; </script>

<script>
  // ===== helpers base =====
  const API=(window.CIE297_API||'').replace(/\/+$/,''); // '/api' o 'https://host.com/api'
  const qs=s=>document.querySelector(s), qsa=s=>[...document.querySelectorAll(s)];
  const esc=s=>String(s??'').replace(/[&<>"]/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[m]));
  const authHeaders=()=>({'Content-Type':'application/json','Authorization':'Bearer '+(localStorage.getItem('token')||'')});

  function fmtDateTime(iso){const d=new Date(iso||Date.now());
    const y=d.getFullYear(),m=('0'+(d.getMonth()+1)).slice(-2),da=('0'+d.getDate()).slice(-2),
          hh=('0'+d.getHours()).slice(-2),mm=('0'+d.getMinutes()).slice(-2),ss=('0'+d.getSeconds()).slice(-2);
    return `${y}-${m}-${da} ${hh}:${mm}:${ss}`;}
  function chipNivel(n){n=(n||'').toUpperCase();const e=document.createElement('span');
    e.className='chip '+(n==='ALTA'?'chip--alta':n==='BAJA'?'chip--baja':'chip--media');e.textContent=n;return e;}

  // ===== parseo tolerante =====
  async function parseJSONorText(resp){const txt=await resp.text();try{return{data:JSON.parse(txt),raw:txt}}catch{return{data:null,raw:txt}}}

  // ===== API (sin duplicar /api) =====
  async function apiLogin(email,password){
    const r=await fetch(`${API}/login`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({email,password})});
    const {data,raw}=await parseJSONorText(r);
    if(!r.ok) throw new Error(`Login falló [${r.status}]: ${(data&&(data.message||data.error))||raw.slice(0,140)}`);
    localStorage.setItem('token',data.token); window._me=data.user; window._isAdmin=!!data.user?.is_admin; return data;
  }
  async function apiMe(){
    const r=await fetch(`${API}/me`,{headers:authHeaders()}); if(!r.ok) return null;
    const {data}=await parseJSONorText(r); window._me=data.user; window._isAdmin=!!data.user?.is_admin; return data.user;
  }
  async function apiCreateAccount(p){
    const r=await fetch(`${API}/register`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(p)});
    const {data,raw}=await parseJSONorText(r); if(!r.ok) throw new Error((data&&data.message)||raw.slice(0,140)||'Error registrar'); return data;
  }
  async function apiSendReport(p){
    const r=await fetch(`${API}/reports`,{method:'POST',headers:authHeaders(),body:JSON.stringify(p)});
    const {data,raw}=await parseJSONorText(r); if(!r.ok) throw new Error((data&&data.message)||raw.slice(0,140)||'Error enviar'); return data;
  }
  async function apiGetAlerts(limit=10){
    const r=await fetch(`${API}/admin/alerts?limit=${limit}`,{headers:authHeaders()});
    const {data,raw}=await parseJSONorText(r); if(!r.ok) throw new Error((data&&data.message)||raw.slice(0,140)||'Error listar'); return data.items||[];
  }
  async function apiGetAccesses(limit=50){
    try{
      const r=await fetch(`${API}/admin/access?limit=${limit}`,{headers:authHeaders()});
      if(!r.ok) throw new Error('noaccess');
      const {data}=await parseJSONorText(r); return data.items||[];
    }catch(_){ return {__error:'No existe endpoint /admin/access'}; }
  }

  // ===== vistas =====
  function render(v){
    qsa('[data-view]').forEach(e=>e.classList.add('hidden'));
    qs(`[data-view="${v}"]`).classList.remove('hidden');
    if(v==='dashboard'||v==='admin'){qs('#btnLogout').classList.remove('hidden')}else{qs('#btnLogout').classList.add('hidden')}
    qs('#hello').textContent=window._me?(' | '+(window._me.grado||'')+' '+(window._me.nombres||'')) : '';
  }

  // ===== login =====
  async function doLogin(){
    try{
      await apiLogin(qs('#loginEmail').value.trim(),qs('#loginPass').value.trim());
      if(window._isAdmin){initAdmin();render('admin')}else{initUser();render('dashboard')}
    }catch(e){ alert(e.message) }
  }

  // ===== registro =====
  async function createAccount(){
    const p={grado:qs('#grado').value,especialidad:qs('#especialidad').value.trim(),nombres:qs('#nombres').value.trim(),
             apellidos:qs('#apellidos').value.trim(),email:qs('#email').value.trim(),password:qs('#password').value.trim()};
    try{ await apiCreateAccount(p); alert('Usuario creado. Inicia sesión.'); render('login'); }
    catch(e){ alert(e.message) }
  }

  // ===== tablas / recientes =====
  function paintLatest(sel,items){
    const tb=qs(sel); tb.innerHTML='';
    (items||[]).forEach(it=>{
      const tr=document.createElement('tr');
      tr.innerHTML=`<td>${it.id??''}</td>
                    <td>${fmtDateTime(it.fecha||it.created_at)}</td>
                    <td data-chip></td>
                    <td>${esc(it.tipo||'')}</td>
                    <td>${esc(it.usuario||'')}</td>
                    <td>${(it.lat!=null&&it.lng!=null)?((+it.lat).toFixed(4)+', '+(+it.lng).toFixed(4)) : ''}</td>
                    <td>${esc(it.descripcion||'')}</td>`;
      tr.querySelector('[data-chip]').appendChild(chipNivel(it.nivel));
      tb.appendChild(tr);
    });
  }

  // cache para insertar manuales inmediatamente
  window._localManual = [];

  async function refreshLatest(){ const server=await apiGetAlerts(10); const merged=mergeAlerts(server,window._localManual); paintLatest('#listLatest',merged); }
  async function refreshAdmin(){ const server=await apiGetAlerts(10); const merged=mergeAlerts(server,window._localManual); paintLatest('#adminLatest',merged); }
  function mergeAlerts(server,manuals){
    const all=[...(server||[])]; (manuals||[]).forEach(m=>{ const has=all.some(x=>String(x.id)===String(m.id)); if(!has) all.unshift(m); });
    all.sort((a,b)=>new Date(b.fecha||b.created_at)-new Date(a.fecha||a.created_at));
    return all.slice(0,10);
  }

  function nivelAleatorio(){const n=['ALTA','MEDIA','BAJA'],p=[0.25,0.5,0.25];let r=Math.random(),a=0;for(let i=0;i<n.length;i++){a+=p[i];if(r<=a)return n[i]}return 'MEDIA';}
  function startSim(){stopSim();window._sim=setInterval(async()=>{try{
      const nivel=nivelAleatorio();const tipos=['SIMULADO','OBSERVACION','INTERFERENCIA','MOVIMIENTO','OTROS'];
      const tipo=tipos[Math.floor(Math.random()*tipos.length)];const lat=-16.6+Math.random(),lng=-68.2+Math.random();
      const descripcion=nivel==='ALTA'?'Evento crítico (simulado)':nivel==='BAJA'?'Notificación menor (simulado)':'Actividad observada (simulado)';
      await apiSendReport({tipo,nivel,descripcion,lat,lng,sim:true}); if(window._isAdmin)refreshAdmin();else refreshLatest();
    }catch(e){}},5000)}
  function stopSim(){if(window._sim){clearInterval(window._sim);window._sim=null}}

  // envío manual (va vacío, sin sim)
  async function sendQuick(){
    const tipo=qs('#tipo').value,nivel=qs('#nivel').value,msg=qs('#mensaje').value||'',libre=qs('#descripcion').value||'';
    const descripcion=msg?`[${msg}] ${libre}`:libre;
    let lat=qs('#lat').value?+qs('#lat').value:null,lng=qs('#lng').value?+qs('#lng').value:null;
    try{
      const res=await apiSendReport({tipo,nivel,descripcion,lat,lng});
      alert('Reporte enviado'); qs('#descripcion').value='';
      const now=new Date().toISOString();
      const asItem=res?.item||{id:res?.id||('local-'+Date.now()),fecha:now,nivel,tipo,usuario:(window._me?.email)||'',lat,lng,descripcion};
      window._localManual.unshift(asItem);
      if(window._isAdmin)refreshAdmin(); else refreshLatest();
    }catch(e){ alert(e.message) }
  }

  function useLocation(){if(!navigator.geolocation)return alert('Geolocalización no soportada');
    navigator.geolocation.getCurrentPosition(p=>{qs('#lat').value=p.coords.latitude.toFixed(6);qs('#lng').value=p.coords.longitude.toFixed(6)},()=>alert('No se pudo obtener ubicación'),{enableHighAccuracy:true,timeout:7000})}

  async function initUser(){startSim();await refreshLatest()} async function initAdmin(){startSim();await refreshAdmin()}
  function logout(){localStorage.removeItem('token');window._me=null;window._isAdmin=false;stopSim();render('landing')}

  // Ver todas (agrupado por días)
  async function verTodas(){
    const r=await fetch(`${API}/admin/alerts?limit=2000`,{headers:authHeaders()});
    const {data}=await parseJSONorText(r);
    const items=(data.items||[]).sort((a,b)=>new Date(b.fecha||b.created_at)-new Date(a.fecha||a.created_at));
    const g=items.reduce((a,it)=>{const d=new Date(it.fecha||it.created_at);const k=`${d.getFullYear()}-${('0'+(d.getMonth()+1)).slice(-2)}-${('0'+d.getDate()).slice(-2)}`;(a[k]||(a[k]=[])).push(it);return a},{});
    const days=Object.keys(g).sort().reverse();
    const pnl=qs('#panelTodas'); pnl.classList.remove('hidden');
    pnl.innerHTML=days.map(day=>{
      const rows=g[day].map(it=>`<tr><td>${it.id??''}</td><td>${fmtDateTime(it.fecha||it.created_at)}</td><td>${esc(it.nivel||'')}</td><td>${esc(it.tipo||'')}</td><td>${esc(it.usuario||'')}</td><td>${(it.lat!=null&&it.lng!=null)?((+it.lat).toFixed(4)+', '+(+it.lng).toFixed(4)) : ''}</td><td>${esc(it.descripcion||'')}</td></tr>`).join('');
      return `<div class="row" style="justify-content:space-between;align-items:center;margin:6px 0">
        <div class="title">Reportes del ${day}</div>
        <div class="row" style="gap:6px">
          <button class="btn btn-secondary" data-exp-pdf="${day}">Exportar PDF</button>
          <button class="btn" data-exp-csv="${day}">Exportar CSV</button>
        </div></div>
        <div class="table-wrap"><table><thead><tr>
          <th>ID</th><th>Fecha</th><th>Nivel</th><th>Tipo</th><th>Usuario</th><th>Ubicación</th><th>Descripción</th>
        </tr></thead><tbody>${rows}</tbody></table></div>`;
    }).join('');
  }
  async function onExport(ev){
    const pdf=ev.target.closest('[data-exp-pdf]'),csv=ev.target.closest('[data-exp-csv]'); if(!pdf&&!csv)return;
    const day=(pdf&&pdf.dataset.expPdf)||(csv&&csv.dataset.expCsv);
    const base = pdf ? `${API}/admin/alerts/export/pdf` : `${API}/admin/alerts/export/csv`;
    const url = `${base}?date=${encodeURIComponent(day)}`;
    const r=await fetch(url,{headers:authHeaders()}); const blob=await r.blob();
    const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download=pdf?`reporte_${day}.pdf`:`reporte_${day}.csv`; a.click(); URL.revokeObjectURL(a.href);
  }

  // Accesos
  async function openAccess(){
    const box=qs('#accessBody'); box.innerHTML='<div class="muted">Cargando…</div>';
    const data=await apiGetAccesses(50);
    if(data && data.__error){ box.innerHTML=`<div class="muted">⚠ ${data.__error}. Configura el endpoint en el backend.</div>`; qs('#accessModal').style.display='flex'; return; }
    const rows=(data||[]).map(a=>`<tr><td>${fmtDateTime(a.fecha||a.created_at)}</td><td>${esc(a.email||a.usuario||'')}</td><td>${esc(a.estado||a.status||'OK')}</td><td><button class="btn btn-danger" data-bloq="${esc(a.email||'')}">Bloquear</button></td></tr>`).join('');
    box.innerHTML=`<div class="table-wrap"><table><thead><tr><th>Fecha y hora</th><th>Email</th><th>Estado</th><th>Acción</th></tr></thead><tbody>${rows}</tbody></table></div>`;
    qs('#accessModal').style.display='flex';
  }
  function closeAccess(){qs('#accessModal').style.display='none'}

  // ===== init =====
  window.addEventListener('DOMContentLoaded',async()=>{
    // header
    qs('#btnLogout').addEventListener('click',logout);
    // landing
    qs('#btnCreate').addEventListener('click',createAccount);
    qs('#btnGoLogin').addEventListener('click',()=>render('login'));
    // login
    qs('#btnLogin').addEventListener('click',doLogin);
    qs('#btnBack').addEventListener('click',()=>render('landing'));
    // dashboard/admin
    qs('#btnSend').addEventListener('click',sendQuick);
    qs('#btnUseLocation').addEventListener('click',useLocation);
    qs('#btnVerTodas').addEventListener('click',verTodas);
    qs('#panelTodas').addEventListener('click',onExport);
    qs('#btnAccess').addEventListener('click',openAccess);
    qs('#btnCloseAccess').addEventListener('click',closeAccess);

    const me=await apiMe();
    if(me){ if(window._isAdmin){initAdmin();render('admin')}else{initUser();render('dashboard')} }
    else{ render('landing') }

    setInterval(()=>{ if(window._isAdmin)refreshAdmin(); else refreshLatest(); },15000);
  });
</script>
</head>
<body>
<header class="appbar">
  <div class="brand">
    <img src="assets/logo.png" alt="logo">
    <span>CIE-297 | Monitoreo en Tiempo Real <span id="hello" class="muted"></span></span>
  </div>
  <div class="actions">
    <button id="btnLogout" class="btn btn-danger hidden">Cerrar sesión</button>
  </div>
</header>

<div class="container">
  <!-- LANDING (Imagen 1) -->
  <section class="card" data-view="landing">
    <h3>Registro</h3>
    <div class="grid" style="grid-template-columns:1fr auto">
      <div class="col">
        <div class="row">
          <select id="grado" class="control" style="max-width:200px">
            <option value="">Grado</option>
            <option>GRAL</option><option>CNL</option><option>TCNL</option><option>MY</option><option>CAP</option><option>TTE</option><option>SBTTE</option><option>SGTO</option><option>CBOS</option>
          </select>
          <input id="especialidad" placeholder="Especialidad" class="control" style="flex:1">
        </div>
        <div class="row"><input id="nombres" placeholder="Nombres" class="control" style="flex:1"><input id="apellidos" placeholder="Apellidos" class="control" style="flex:1"></div>
        <div class="row"><input id="email" placeholder="Email" class="control" style="flex:1"><input id="password" type="password" placeholder="Contraseña" class="control" style="flex:1"></div>
        <div class="right">
          <button id="btnCreate" class="btn">Crear cuenta</button>
          <button id="btnGoLogin" class="btn btn-secondary" style="margin-left:8px">Iniciar sesión</button>
        </div>
      </div>
    </div>
    <p class="muted">© CIE-297 · Prototipo académico · Tiempo real</p>
  </section>

  <!-- LOGIN (Imagen 2) -->
  <section class="card hidden" data-view="login">
    <h3>Iniciar sesión</h3>
    <div class="col" style="gap:8px;max-width:520px">
      <input id="loginEmail" class="control" placeholder="email">
      <input id="loginPass" type="password" class="control" placeholder="contraseña">
      <div class="row" style="gap:8px">
        <button id="btnLogin" class="btn">Entrar</button>
        <button id="btnBack" class="btn btn-secondary">Cerrar</button>
      </div>
    </div>
  </section>

  <!-- DASHBOARD (usuario) -->
  <section class="grid g-2 hidden" data-view="dashboard">
    <div class="card">
      <h3>Área Operativa</h3>
      <div class="table-wrap" style="height:320px;display:flex;align-items:center;justify-content:center;border-style:dashed">
        <div class="muted">Mapa (Leaflet) — Bolivia</div>
      </div>
      <div class="muted" style="margin-top:6px">Leyenda:
        <span class="chip chip--baja">BAJA</span>
        <span class="chip chip--media">MEDIA</span>
        <span class="chip chip--alta">ALTA</span>
      </div>
    </div>
    <aside class="card"><h3>Órganos de búsqueda</h3><div class="muted">Se listan con claves IEC-SAT (simulado)</div></aside>

    <div class="card" style="grid-column:1 / -1">
      <h3>Misiones / Reportes rápidos</h3>
      <div class="grid" style="grid-template-columns:1fr 1fr">
        <div class="col">
          <label>Tipo</label>
          <select id="tipo" class="control">
            <option>Rebasado</option><option>Relocalización</option><option>Interferencia RF</option><option>Observación</option><option>Incautación de autos</option><option>Secuestro</option><option>Otros</option>
          </select>
        </div>
        <div class="col">
          <label>Nivel</label>
          <select id="nivel" class="control"><option>ALTA</option><option selected>MEDIA</option><option>BAJA</option></select>
        </div>
        <div class="col">
          <label>Mensaje</label>
          <select id="mensaje" class="control">
            <option value="">— seleccionar —</option>
            <option>PETA</option><option>LAMBO</option><option>TRICICLO</option><option>PATINETA</option>
            <option>FRUTAS</option><option>MOTOBOMBA</option><option>CUCHARA</option><option>TENEDOR</option>
            <option>CHISGUETE</option><option>PINTURA ROJA</option><option>PINTURA NARANJA</option>
            <option>PINTURA AZUL</option><option>PINTURA VERDE</option><option>PINTURA AMARILLA</option><option>PINTURA CAFE</option>
            <option>YENAS</option><option>LOBOS</option><option>LIEBRES</option><option>JUGANDO</option>
            <option>RIO PILCOMAYO</option><option>LAGUNA ESCOBAR</option><option>MALLASA</option><option>CIELO NUBLADO</option>
            <option>HOTEL RADISSON</option><option>HERRADURA</option><option>FEDERAL</option><option>CAIMAN</option><option>LAGARTOS</option>
          </select>
        </div>
        <div class="col">
          <label>Ubicación</label>
          <div class="row"><input id="lat" class="control" placeholder="lat"><input id="lng" class="control" placeholder="lng"><button id="btnUseLocation" class="btn">Usar ubicación</button></div>
        </div>
        <div class="col" style="grid-column:1 / -1"><label>Descripción</label><textarea id="descripcion" class="control" rows="3" placeholder="Detallar lo ocurrido…"></textarea></div>
      </div>
      <div class="right" style="margin-top:8px"><button id="btnSend" class="btn">Enviar</button></div>
    </div>

    <div class="card" style="grid-column:1 / -1">
      <div class="row" style="justify-content:space-between;align-items:center"><h3>Alertas (10 más recientes)</h3></div>
      <div class="table-wrap">
        <table><thead><tr><th>ID</th><th>Fecha</th><th>Nivel</th><th>Tipo</th><th>Usuario</th><th>Ubicación</th><th>Descripción</th></tr></thead><tbody id="listLatest"></tbody></table>
      </div>
    </div>
  </section>

  <!-- ADMIN -->
  <section class="grid g-2 hidden" data-view="admin">
    <div class="card">
      <div class="row" style="justify-content:space-between;align-items:center">
        <h3>Alertas (10 más recientes)</h3>
        <div class="row" style="gap:8px">
          <span class="badge">10 más recientes</span>
          <button id="btnVerTodas" class="btn btn-secondary">Ver todas</button>
          <button id="btnAccess" class="btn">Accesos</button>
        </div>
      </div>
      <div class="table-wrap"><table><thead><tr><th>ID</th><th>Fecha</th><th>Nivel</th><th>Tipo</th><th>Usuario</th><th>Ubicación</th><th>Descripción</th></tr></thead><tbody id="adminLatest"></tbody></table></div>
      <div id="panelTodas" class="hidden" style="margin-top:10px"></div>
    </div>
    <aside class="card"><h3>Órganos de búsqueda</h3><div class="muted">Claves IEC-SAT (simulado)</div></aside>
  </section>
</div>

<!-- Modal Accesos -->
<div id="accessModal" class="modal">
  <div class="box">
    <div class="row" style="justify-content:space-between;align-items:center">
      <div class="title">Accesos</div>
      <button id="btnCloseAccess" class="btn btn-secondary">Cerrar</button>
    </div>
    <div id="accessBody"></div>
  </div>
</div>
</body>
</html>
